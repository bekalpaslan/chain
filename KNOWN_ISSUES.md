# âš ï¸ Known Issues & Critical Information

**Last Updated:** 2025-10-30

This document contains recurring issues that agents/developers frequently rediscover. Read this BEFORE troubleshooting!

---

## ğŸ” #1 Password Management Issue (CRITICAL)

### âŒ The Problem
**Manual password updates in the database DO NOT WORK!**

When you manually update the `password_hash` field in the `users` table, authentication will ALWAYS fail.

### âœ… The Solution
**ALWAYS use the `/set-password` endpoint:**

```bash
curl -X POST http://localhost:8080/api/v1/users/set-password \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "newPassword": "yourpassword"
  }'
```

### ğŸ”¬ Technical Explanation

**Why Manual Updates Fail:**
1. Spring Security uses **BCrypt** for password hashing
2. BCrypt generates a **unique salt** for each password
3. The salt is embedded in the hash itself
4. Manual encryption (using online tools, SQL functions, etc.) uses different algorithms or no salt
5. Spring Security's `PasswordEncoder.matches()` requires the exact BCrypt format

**Correct BCrypt Hash Format:**
```
$2a$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhWy
 â”‚  â”‚  â”‚                                                     â”‚
 â”‚  â”‚  â””â”€ Salt (22 chars)                                   â””â”€ Hash (31 chars)
 â”‚  â””â”€ Cost factor (10 rounds)
 â””â”€ Algorithm identifier ($2a = BCrypt)
```

**Why the `/set-password` Endpoint Works:**
```java
// Inside AuthService.java
String hashedPassword = passwordEncoder.encode(newPassword);
user.setPasswordHash(hashedPassword);
```

The `passwordEncoder` bean (configured in `SecurityConfig.java`) properly:
- Generates a secure random salt
- Uses the correct cost factor (10 rounds)
- Creates a properly formatted BCrypt hash

### ğŸ“ Common Test User Quick Fix

```bash
# testuser_50 (position 50, has active ticket, 1 strike)
curl -X POST http://localhost:8080/api/v1/users/set-password \
  -H "Content-Type: application/json" \
  -d '{"email": "testuser_50@test.com", "newPassword": "password123"}'

# testuser_01 (seed user, position 1)
curl -X POST http://localhost:8080/api/v1/users/set-password \
  -H "Content-Type: application/json" \
  -d '{"email": "alpaslan@alpaslan.com", "newPassword": "alpaslan"}'
```

### â±ï¸ Time Wasted on This Issue

Agents have spent **2-4 hours** each session rediscovering this issue:
- October 15: 3 hours debugging "wrong password" errors
- October 22: 2 hours trying different hash algorithms
- October 28: 4 hours attempting SQL bcrypt functions
- October 30: Issue finally documented!

**Remember:** NEVER manually update `password_hash` in the database!

---

## ğŸŸï¸ #2 Automatic Ticket System (CRITICAL)

### âŒ The Misconception
**Tickets are NOT generated by users clicking a button!**

### âœ… The Reality
**Tickets are AUTOMATICALLY created by the system.**

**When Tickets are Created:**
1. **On User Registration** - First ticket auto-created
2. **On Ticket Expiration** - New ticket auto-created (adds strike)
3. **On Ticket Cancellation** - New ticket auto-created (adds strike)

**When Tickets are NOT Created:**
- âŒ User clicking "Generate Ticket" button (this button shouldn't exist!)
- âŒ User calling `POST /tickets/generate` endpoint (this endpoint doesn't exist!)
- âŒ User manually in the UI (no user action needed)

### ğŸ”„ Ticket Lifecycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User Joins Chain                             â”‚
â”‚ â””â”€â–º Ticket Auto-Created (24h expiration)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                       â”‚
        â–¼                       â–¼
   [Expires]              [Used Successfully]
        â”‚                       â”‚
        â–¼                       â–¼
  New Ticket            âœ… User DONE!
  Auto-Created          No more tickets
  Strike +1             FAB hidden
        â”‚
        â–¼
  Strike 2/3? â†’ Repeat
        â”‚
        â–¼
  Strike 3/3? â†’ ğŸš« User Removed
```

### ğŸ’» What This Means for Code

**Frontend (Flutter):**
- âœ… `TicketViewScreen` - View active ticket
- âœ… FAB button labeled "View Ticket" (not "Generate")
- âœ… Ticket banner on dashboard (when ticket exists)
- âœ… API call: `GET /tickets/me/active`
- âŒ ~~"Generate Ticket" button~~ (REMOVE if found)
- âŒ ~~`POST /tickets/generate`~~ (WRONG endpoint)

**Backend (Spring Boot):**
- âœ… `TicketService.createTicketForUser()` - Auto-creation logic
- âœ… `TicketExpirationScheduler` - Handles expiration â†’ renewal
- âœ… `GET /tickets/me/active` - Returns user's active ticket
- âŒ ~~`POST /tickets/generate`~~ (Should NOT exist)

### ğŸ“ Key Files

**Backend:**
```
backend/src/main/java/com/thechain/
â”œâ”€â”€ service/TicketService.java           â† Auto-creation logic
â”œâ”€â”€ service/AuthService.java             â† Creates ticket on registration
â”œâ”€â”€ scheduler/TicketExpirationScheduler.java  â† Auto-renewal on expiration
â””â”€â”€ controller/TicketController.java     â† GET /tickets/me/active
```

**Frontend:**
```
frontend/private-app/lib/
â”œâ”€â”€ screens/ticket_view_screen.dart      â† Full-screen ticket view
â”œâ”€â”€ screens/dashboard_screen.dart        â† Shows FAB + banner
â”œâ”€â”€ widgets/ticket/ticket_share_fab.dart â† FAB button
â””â”€â”€ providers/ticket_providers.dart      â† Ticket state management
```

**Documentation:**
```
docs/
â”œâ”€â”€ USER_FLOWS.md              â† Flow 2: "View and Share" (not generate)
â”œâ”€â”€ API_SPECIFICATION.md       â† GET /tickets/me/active
â”œâ”€â”€ PROJECT_DEFINITION.md      â† Automatic ticket concept
â””â”€â”€ IMPLEMENTATION_STATUS.md   â† Ticket endpoints
```

### â±ï¸ Time Wasted on This Issue

Agents have spent **3-5 hours** each session implementing the wrong system:
- October 12: Built "Generate Ticket" UI (wrong!)
- October 18: Created `POST /tickets/generate` endpoint (wrong!)
- October 25: Added "Generate" button to dashboard (wrong!)
- October 30: Corrected all code and documentation

**Remember:** Tickets are AUTOMATIC! Users VIEW them, not generate them!

---

## ğŸ› #3 Other Known Issues

### CORS Configuration (Resolved)
**Status:** âœ… Fixed
- CORS now allows `localhost:3000` and `localhost:3001`
- Configured in `SecurityConfig.java`

### Database Connection (Resolved)
**Status:** âœ… Fixed
- Docker Compose now properly links services
- Connection string: `jdbc:postgresql://postgres:5432/chaindb`

### Flutter Build Time (Ongoing)
**Status:** âš ï¸ First build takes 30+ minutes
- **Workaround:** Use `flutter build web --release` once, then incremental builds are fast
- **Note:** This is normal for Flutter web builds

---

## ğŸ“ How to Add New Known Issues

If you discover a recurring issue:

1. **Document it here** with:
   - Clear problem statement
   - Technical explanation
   - Working solution
   - Time estimate if available

2. **Update CLAUDE_START_HERE.md** with a brief mention

3. **Add to relevant docs** (API_SPECIFICATION.md, USER_FLOWS.md, etc.)

4. **Create code comments** where the issue commonly occurs

---

## ğŸ”— Related Documents

- [CLAUDE_START_HERE.md](CLAUDE_START_HERE.md) - Quick project overview
- [README.md](README.md) - Full project documentation
- [API_SPECIFICATION.md](docs/API_SPECIFICATION.md) - Complete API reference
- [USER_FLOWS.md](docs/USER_FLOWS.md) - User interaction flows

---

*This document saves hours of debugging time. Keep it updated!*
