# ⚠️ Known Issues & Critical Information

**Last Updated:** 2025-10-30

This document contains recurring issues that agents/developers frequently rediscover. Read this BEFORE troubleshooting!

---

## 🔐 #1 Password Management Issue (CRITICAL)

### ❌ The Problem
**Manual password updates in the database DO NOT WORK!**

When you manually update the `password_hash` field in the `users` table, authentication will ALWAYS fail.

### ✅ The Solution
**ALWAYS use the `/set-password` endpoint:**

```bash
curl -X POST http://localhost:8080/api/v1/users/set-password \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "newPassword": "yourpassword"
  }'
```

### 🔬 Technical Explanation

**Why Manual Updates Fail:**
1. Spring Security uses **BCrypt** for password hashing
2. BCrypt generates a **unique salt** for each password
3. The salt is embedded in the hash itself
4. Manual encryption (using online tools, SQL functions, etc.) uses different algorithms or no salt
5. Spring Security's `PasswordEncoder.matches()` requires the exact BCrypt format

**Correct BCrypt Hash Format:**
```
$2a$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhWy
 │  │  │                                                     │
 │  │  └─ Salt (22 chars)                                   └─ Hash (31 chars)
 │  └─ Cost factor (10 rounds)
 └─ Algorithm identifier ($2a = BCrypt)
```

**Why the `/set-password` Endpoint Works:**
```java
// Inside AuthService.java
String hashedPassword = passwordEncoder.encode(newPassword);
user.setPasswordHash(hashedPassword);
```

The `passwordEncoder` bean (configured in `SecurityConfig.java`) properly:
- Generates a secure random salt
- Uses the correct cost factor (10 rounds)
- Creates a properly formatted BCrypt hash

### 📝 Common Test User Quick Fix

```bash
# testuser_50 (position 50, has active ticket, 1 strike)
curl -X POST http://localhost:8080/api/v1/users/set-password \
  -H "Content-Type: application/json" \
  -d '{"email": "testuser_50@test.com", "newPassword": "password123"}'

# testuser_01 (seed user, position 1)
curl -X POST http://localhost:8080/api/v1/users/set-password \
  -H "Content-Type: application/json" \
  -d '{"email": "alpaslan@alpaslan.com", "newPassword": "alpaslan"}'
```

### ⏱️ Time Wasted on This Issue

Agents have spent **2-4 hours** each session rediscovering this issue:
- October 15: 3 hours debugging "wrong password" errors
- October 22: 2 hours trying different hash algorithms
- October 28: 4 hours attempting SQL bcrypt functions
- October 30: Issue finally documented!

**Remember:** NEVER manually update `password_hash` in the database!

---

## 🎟️ #2 Automatic Ticket System (CRITICAL)

### ❌ The Misconception
**Tickets are NOT generated by users clicking a button!**

### ✅ The Reality
**Tickets are AUTOMATICALLY created by the system.**

**When Tickets are Created:**
1. **On User Registration** - First ticket auto-created
2. **On Ticket Expiration** - New ticket auto-created (adds strike)
3. **On Ticket Cancellation** - New ticket auto-created (adds strike)

**When Tickets are NOT Created:**
- ❌ User clicking "Generate Ticket" button (this button shouldn't exist!)
- ❌ User calling `POST /tickets/generate` endpoint (this endpoint doesn't exist!)
- ❌ User manually in the UI (no user action needed)

### 🔄 Ticket Lifecycle

```
┌─────────────────────────────────────────────┐
│ User Joins Chain                             │
│ └─► Ticket Auto-Created (24h expiration)    │
└─────────────────────────────────────────────┘
                    │
        ┌───────────┴───────────┐
        │                       │
        ▼                       ▼
   [Expires]              [Used Successfully]
        │                       │
        ▼                       ▼
  New Ticket            ✅ User DONE!
  Auto-Created          No more tickets
  Strike +1             FAB hidden
        │
        ▼
  Strike 2/3? → Repeat
        │
        ▼
  Strike 3/3? → 🚫 User Removed
```

### 💻 What This Means for Code

**Frontend (Flutter):**
- ✅ `TicketViewScreen` - View active ticket
- ✅ FAB button labeled "View Ticket" (not "Generate")
- ✅ Ticket banner on dashboard (when ticket exists)
- ✅ API call: `GET /tickets/me/active`
- ❌ ~~"Generate Ticket" button~~ (REMOVE if found)
- ❌ ~~`POST /tickets/generate`~~ (WRONG endpoint)

**Backend (Spring Boot):**
- ✅ `TicketService.createTicketForUser()` - Auto-creation logic
- ✅ `TicketExpirationScheduler` - Handles expiration → renewal
- ✅ `GET /tickets/me/active` - Returns user's active ticket
- ❌ ~~`POST /tickets/generate`~~ (Should NOT exist)

### 📁 Key Files

**Backend:**
```
backend/src/main/java/com/thechain/
├── service/TicketService.java           ← Auto-creation logic
├── service/AuthService.java             ← Creates ticket on registration
├── scheduler/TicketExpirationScheduler.java  ← Auto-renewal on expiration
└── controller/TicketController.java     ← GET /tickets/me/active
```

**Frontend:**
```
frontend/private-app/lib/
├── screens/ticket_view_screen.dart      ← Full-screen ticket view
├── screens/dashboard_screen.dart        ← Shows FAB + banner
├── widgets/ticket/ticket_share_fab.dart ← FAB button
└── providers/ticket_providers.dart      ← Ticket state management
```

**Documentation:**
```
docs/
├── USER_FLOWS.md              ← Flow 2: "View and Share" (not generate)
├── API_SPECIFICATION.md       ← GET /tickets/me/active
├── PROJECT_DEFINITION.md      ← Automatic ticket concept
└── IMPLEMENTATION_STATUS.md   ← Ticket endpoints
```

### ⏱️ Time Wasted on This Issue

Agents have spent **3-5 hours** each session implementing the wrong system:
- October 12: Built "Generate Ticket" UI (wrong!)
- October 18: Created `POST /tickets/generate` endpoint (wrong!)
- October 25: Added "Generate" button to dashboard (wrong!)
- October 30: Corrected all code and documentation

**Remember:** Tickets are AUTOMATIC! Users VIEW them, not generate them!

---

## 🐛 #3 Other Known Issues

### CORS Configuration (Resolved)
**Status:** ✅ Fixed
- CORS now allows `localhost:3000` and `localhost:3001`
- Configured in `SecurityConfig.java`

### Database Connection (Resolved)
**Status:** ✅ Fixed
- Docker Compose now properly links services
- Connection string: `jdbc:postgresql://postgres:5432/chaindb`

### Flutter Build Time (Ongoing)
**Status:** ⚠️ First build takes 30+ minutes
- **Workaround:** Use `flutter build web --release` once, then incremental builds are fast
- **Note:** This is normal for Flutter web builds

---

## 📝 How to Add New Known Issues

If you discover a recurring issue:

1. **Document it here** with:
   - Clear problem statement
   - Technical explanation
   - Working solution
   - Time estimate if available

2. **Update CLAUDE_START_HERE.md** with a brief mention

3. **Add to relevant docs** (API_SPECIFICATION.md, USER_FLOWS.md, etc.)

4. **Create code comments** where the issue commonly occurs

---

## 🔗 Related Documents

- [CLAUDE_START_HERE.md](CLAUDE_START_HERE.md) - Quick project overview
- [README.md](README.md) - Full project documentation
- [API_SPECIFICATION.md](docs/API_SPECIFICATION.md) - Complete API reference
- [USER_FLOWS.md](docs/USER_FLOWS.md) - User interaction flows

---

*This document saves hours of debugging time. Keep it updated!*
